<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AXE: Duplicate Execution and Heredoc Parsing Bug Fixes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">AXE
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_DUPLICATE__EXECUTION__FIX__SUMMARY.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Duplicate Execution and Heredoc Parsing Bug Fixes </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md308"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md309"></a>
Summary</h1>
<p>This document describes the fixes implemented for two critical bugs in the AXE tool execution system that affected both interactive mode (<span class="tt">@agent</span> commands) and collaborative mode (<span class="tt">/collab</span>).</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md310"></a>
Bug 1: Duplicate Command Execution ❌ → ✅</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md311"></a>
Problem</h2>
<p>Commands in agent responses were being executed <b>twice</b>, causing:</p><ul>
<li>Double execution of side-effect commands (e.g., <span class="tt">rm</span> deleting a file, then failing on second attempt)</li>
<li>Duplicate output with confusing XML tags showing</li>
<li>Wasted resources and potential data corruption</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md312"></a>
Root Cause</h2>
<p>Both <span class="tt"><a class="el" href="xml__tool__parser_8py.html">xml_tool_parser.py</a></span> and <span class="tt"><a class="el" href="axe_8py.html">axe.py</a></span> were parsing the same code blocks:</p><ol type="1">
<li><span class="tt">xml_tool_parser.parse_axe_native_blocks()</span> parsed <span class="tt"> ``</span>EXEC<span class="tt">, </span> <span class="tt">READ`, ` </span>WRITE<span class="tt"> blocks</span></li>
<li><span class="tt"></span><a class="el" href="axe_8py.html">axe.py</a><span class="tt"> </span>ResponseProcessor.process_response()` ALSO parsed the same blocks with regex</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md313"></a>
Example of Duplicate Execution (Before Fix)</h2>
<div class="fragment"><div class="line">--- Execution Results ---</div>
<div class="line">&lt;result&gt;                              ← XML parser execution</div>
<div class="line">&lt;function_result&gt;</div>
<div class="line">&lt;result&gt;</div>
<div class="line">[Command executed successfully]</div>
<div class="line">&lt;/result&gt;</div>
<div class="line">&lt;/function_result&gt;</div>
<div class="line">&lt;/result&gt;</div>
<div class="line">[EXEC: rm /tmp/AXE/gpt.txt]           ← Markdown parser execution (FAILS!)</div>
<div class="line">ERROR: Exit code 1: rm: cannot remove &#39;/tmp/AXE/gpt.txt&#39;: No such file</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md314"></a>
Solution</h2>
<p><b>Removed <span class="tt">parse_axe_native_blocks()</span> from <span class="tt">parse_all_tool_formats()</span></b></p>
<p>The native <span class="tt"> ``</span>READ<span class="tt">, </span> <span class="tt">EXEC`, ` </span>WRITE<span class="tt"> blocks are now handled exclusively by </span><a class="el" href="axe_8py.html">axe.py</a><span class="tt">'s </span>ResponseProcessor`, which is the original and more robust handler with full heredoc support.</p>
<p><b>Changes in <span class="tt"><a class="el" href="xml__tool__parser_8py.html">utils/xml_tool_parser.py</a></span>:</b> </p><div class="fragment"><div class="line"><span class="keyword">def </span>parse_all_tool_formats(response: str) -&gt; List[Dict[str, Any]]:</div>
<div class="line">    calls = []</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># 1. XML function_calls format</span></div>
<div class="line">    calls.extend(parse_xml_function_calls(response))</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># 2. &lt;bash&gt; format</span></div>
<div class="line">    calls.extend(parse_bash_tags(response))</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># 3. </span></div>
</div><!-- fragment --><p> bash / <span class="tt">shell / </span>sh code blocks calls.extend(parse_shell_codeblocks(response))</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md315"></a>
4. REMOVED: AXE native <span class="tt">READ/WRITE/EXEC</span> blocks</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md316"></a>
These are now handled EXCLUSIVELY by axe.py ResponseProcessor</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md317"></a>
to prevent duplicate execution</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md318"></a>
calls.extend(parse_axe_native_blocks(response)) # COMMENTED OUT</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md319"></a>
5. Simple XML tags like &lt;read_file&gt;, &lt;shell&gt;</h1>
<p>calls.extend(parse_simple_xml_tags(response))</p>
<p>return deduplicate_calls(calls) </p><div class="fragment"><div class="line">### After Fix</div>
<div class="line">Commands are executed only once:</div>
</div><!-- fragment --><p> &mdash; Execution Results &mdash; [EXEC: rm /tmp/AXE/gpt.txt] [Command executed successfully] </p><div class="fragment"><div class="line">## Bug 2: Heredoc Parsing Errors ❌ → ✅</div>
<div class="line"> </div>
<div class="line">### Problem</div>
<div class="line">When agents used heredocs in shell code blocks, content lines were incorrectly parsed as separate commands:</div>
</div><!-- fragment --><p> bash cat &lt;&lt; EOF &gt; file.md</p><ul>
<li>Item 1</li>
<li>Item 2 <br  />
</li>
</ul>
<ol type="1">
<li>First step EOF <div class="fragment"><div class="line">Caused errors like:</div>
</div><!-- fragment --> ERROR: Tool '-' not in whitelist ERROR: Tool '1.' not in whitelist ERROR: Tool 'EOF' not in whitelist <div class="fragment"><div class="line">### Root Cause</div>
<div class="line">`parse_shell_codeblocks()` in `xml_tool_parser.py` split on newlines without detecting heredocs.</div>
<div class="line"> </div>
<div class="line">### Solution</div>
<div class="line">**Added heredoc detection and proper handling**</div>
<div class="line"> </div>
<div class="line">**New helper function:**</div>
</div><!-- fragment --> python def _contains_heredoc(content: str) -&gt; bool: """
    Check if content contains a heredoc marker.
    Detects: &lt;&lt; EOF, &lt;&lt;- EOF, &lt;&lt;'EOF', &lt;&lt;"EOF", &lt;&lt;&lt; (here-string)
    """ heredoc_pattern = r'&lt;&lt;-?\s*[\'"]?\w+[\'"]?|&lt;&lt;&lt;' return bool(re.search(heredoc_pattern, content)) <div class="fragment"><div class="line">**Modified `parse_shell_codeblocks()`:**</div>
</div><!-- fragment --> python def parse_shell_codeblocks(response: str) -&gt; List[Dict[str, Any]]: pattern = r'<span class="tt">(?:bash|shell|sh)\n?(.*?)</span>' calls = [] for match in re.findall(pattern, response, re.DOTALL): cmd = match.strip() if cmd: </li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md320"></a>
Check if the entire block contains a heredoc</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md321"></a>
If so, treat the whole block as a single command</h1>
<p>if _contains_heredoc(cmd): calls.append({ 'tool': 'EXEC', 'params': {'command': cmd}, 'raw_name': 'shell' }) else: </p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md322"></a>
No heredoc - process line by line as before</h1>
<p>for command in _split_shell_commands(cmd): if command and not command.startswith('#'): calls.append({ 'tool': 'EXEC', 'params': {'command': command}, 'raw_name': 'shell' }) return calls </p><div class="fragment"><div class="line">### Supported Heredoc Formats</div>
<div class="line">- `&lt;&lt; EOF` - Standard heredoc</div>
<div class="line">- `&lt;&lt;- EOF` - Indented heredoc (strips leading tabs)</div>
<div class="line">- `&lt;&lt; &#39;EOF&#39;` - Quoted delimiter (no variable expansion)</div>
<div class="line">- `&lt;&lt; &quot;EOF&quot;` - Quoted delimiter (with variable expansion)</div>
<div class="line">- `&lt;&lt;&lt; &quot;string&quot;` - Here-string</div>
<div class="line"> </div>
<div class="line">### After Fix</div>
<div class="line">Heredocs are preserved as single commands:</div>
</div><!-- fragment --><p> python </p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md323"></a>
Input:</h1>
<p>"""```bash
cat &lt;&lt; EOF &gt; notes.md
- Item 1
- Item 2
EOF
@icode """</p>
<p># Parsed as: [ { 'tool': 'EXEC', 'params': { 'command': 'cat &lt;&lt; EOF &gt; notes.md<br  />
- Item 1<br  />
- Item 2\nEOF' }, 'raw_name': 'shell' } ] </p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md324"></a>
Test Coverage</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md325"></a>
New Tests Added</h3>
<ol type="1">
<li><b><span class="tt">test_no_duplicate_execution()</span></b> - Verifies commands are only parsed once</li>
<li><b><span class="tt">test_heredoc_in_shell_block()</span></b> - Verifies heredocs are preserved as single commands</li>
<li><b><span class="tt">test_multiline_without_heredoc()</span></b> - Ensures regular multi-line commands still work</li>
<li><b><span class="tt">test_heredoc_variations()</span></b> - Tests various heredoc formats (&lt;&lt;, &lt;&lt;-, &lt;&lt;&lt;)</li>
</ol>
<h3 class="doxsection"><a class="anchor" id="autotoc_md326"></a>
Test Results</h3>
<div class="fragment"><div class="line">======================================================================</div>
<div class="line">✅ ALL TESTS PASSED! (43/43)</div>
<div class="line">======================================================================</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md327"></a>
Examples</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md328"></a>
Example 1: No Duplicate Execution</h3>
<div class="fragment"><div class="line"><span class="comment"># Agent response with EXEC block</span></div>
<div class="line">response = <span class="stringliteral">&quot;&quot;&quot;I&#39;ll delete the file:</span></div>
</div><!-- fragment --><p> EXEC rm test.txt </p><div class="fragment"><div class="line">Done!&quot;&quot;&quot;</div>
<div class="line"> </div>
<div class="line"># Before fix: parse_all_tool_formats would parse it, then ResponseProcessor would parse it again</div>
<div class="line"># After fix: Only ResponseProcessor handles it</div>
<div class="line">calls = parse_all_tool_formats(response)</div>
<div class="line">assert len(calls) == 0  # ✅ Not parsed by xml_tool_parser anymore</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md329"></a>
Example 2: Heredoc Preserved</h3>
<div class="fragment"><div class="line"># Agent response with heredoc</div>
<div class="line">response = &quot;&quot;&quot;</div>
</div><!-- fragment --><p> bash cat &lt;&lt; EOF &gt; output.md </p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md330"></a>
Header</h1>
<ul>
<li>Item 1</li>
<li>Item 2 EOF <div class="fragment"><div class="line"> &quot;&quot;&quot;</div>
<div class="line"> </div>
<div class="line"># Before fix: Would create 4 separate commands (cat, &quot;# Header&quot;, &quot;- Item 1&quot;, &quot;- Item 2&quot;)</div>
<div class="line"># After fix: Creates 1 command with entire heredoc</div>
<div class="line">calls = parse_shell_codeblocks(response)</div>
<div class="line">assert len(calls) == 1  # ✅ Single command</div>
<div class="line">assert &#39;- Item 1&#39; in calls[0][&#39;params&#39;][&#39;command&#39;]  # ✅ Content preserved</div>
</div><!-- fragment --></li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md331"></a>
Example 3: Backward Compatibility</h3>
<div class="fragment"><div class="line"><span class="comment"># Regular multi-line commands still work</span></div>
<div class="line">response = <span class="stringliteral">&quot;&quot;&quot;</span></div>
</div><!-- fragment --><p> bash echo "line 1" echo "line 2" </p><div class="fragment"><div class="line"> &quot;&quot;&quot;</div>
<div class="line"> </div>
<div class="line"># Still creates 2 separate commands (no heredoc detected)</div>
<div class="line">calls = parse_shell_codeblocks(response)</div>
<div class="line">assert len(calls) == 2  # ✅ Backward compatible</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md332"></a>
Impact</h2>
<ul>
<li>✅ **Interactive mode (<span class="tt">@agent</span>)**: Fixed - no more duplicate executions</li>
<li>✅ <b>Collaborative mode (<span class="tt">/collab</span>)</b>: Fixed - no more duplicate executions <br  />
</li>
<li>✅ <b>Backward compatibility</b>: Maintained - all existing functionality works</li>
<li>✅ <b>Performance</b>: Slightly improved (no duplicate executions)</li>
<li>✅ <b>Heredoc support</b>: Now properly handled in shell blocks</li>
<li>✅ <b>Error reduction</b>: No more "tool not in whitelist" errors for heredoc content</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md333"></a>
Files Modified</h2>
<ol type="1">
<li><b><span class="tt"><a class="el" href="xml__tool__parser_8py.html">utils/xml_tool_parser.py</a></span></b>:<ul>
<li>Commented out <span class="tt">parse_axe_native_blocks()</span> call in <span class="tt">parse_all_tool_formats()</span></li>
<li>Added <span class="tt">_contains_heredoc()</span> helper function</li>
<li>Modified <span class="tt">parse_shell_codeblocks()</span> to handle heredocs</li>
<li>Added documentation explaining the changes</li>
</ul>
</li>
<li><b><span class="tt"><a class="el" href="test__xml__tool__parser_8py.html">test_xml_tool_parser.py</a></span></b>:<ul>
<li>Updated <span class="tt">test_mixed_formats()</span> to reflect changes</li>
<li>Added 4 new test functions for bug fixes</li>
<li>All 43 tests pass</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md334"></a>
Verification</h2>
<p>To verify the fixes work:</p>
<div class="fragment"><div class="line"># Run the test suite</div>
<div class="line">python3 test_xml_tool_parser.py</div>
<div class="line"> </div>
<div class="line"># Quick verification</div>
<div class="line">python3 -c &quot;</div>
<div class="line">from utils.xml_tool_parser import parse_all_tool_formats, parse_shell_codeblocks</div>
<div class="line"> </div>
<div class="line"># Test 1: No duplicate parsing</div>
<div class="line">response1 = &#39;\`\`\`EXEC ls\n\`\`\`&#39;</div>
<div class="line">calls1 = parse_all_tool_formats(response1)</div>
<div class="line">assert len(calls1) == 0, &#39;Native blocks should not be parsed&#39;</div>
<div class="line"> </div>
<div class="line"># Test 2: Heredoc preserved</div>
<div class="line">response2 = &#39;\`\`\`bash\ncat &lt;&lt; EOF\nline1\nEOF\n\`\`\`&#39;</div>
<div class="line">calls2 = parse_shell_codeblocks(response2)</div>
<div class="line">assert len(calls2) == 1, &#39;Heredoc should be single command&#39;</div>
<div class="line">assert &#39;&lt;&lt; EOF&#39; in calls2[0][&#39;params&#39;][&#39;command&#39;], &#39;Heredoc marker preserved&#39;</div>
<div class="line"> </div>
<div class="line">print(&#39;✅ All verifications passed!&#39;)</div>
<div class="line">&quot;</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md335"></a>
Conclusion</h2>
<p>Both bugs have been successfully fixed:</p><ol type="1">
<li>✅ Commands are no longer executed twice</li>
<li>✅ Heredocs are properly handled in shell blocks</li>
<li>✅ All existing tests pass</li>
<li>✅ New tests verify the fixes</li>
<li>✅ Backward compatibility maintained </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
